# Development Guide

## Getting Started

### 1. Setup Environment

Run the setup script on your Debian 13 node:

```bash
./dev-setup.sh
```

This installs K3S, PostgreSQL, and all development tools.

### 2. Verify Setup

```bash
./verify-setup.sh
```

### 3. Initialize Go Dependencies

```bash
make init
go mod tidy
```

### 4. Run Database Migrations

```bash
make migrate
```

This will create the `apps` table in PostgreSQL.

### 5. Generate Code from SQL

```bash
make sqlc-generate
```

This generates Go code in `internal/db/` from your SQL queries.

## Running the API Server

### Option 1: With Live Reload (Recommended for Development)

```bash
make dev
```

This uses [Air](https://github.com/cosmtrek/air) for automatic reloading when code changes.

### Option 2: Direct Run

```bash
cd cmd/api
go run main.go
```

### Option 3: Build and Run

```bash
make build
./bin/superfly-api
```

## Testing the API

### Create an App (Deploy nginx)

```bash
curl -X POST http://localhost:8080/api/apps \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Nginx",
    "image": "nginx:latest",
    "port": 80,
    "domain": "test.example.com"
  }'
```

Response:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "slug": "test-nginx",
  "name": "Test Nginx",
  "image": "nginx:latest",
  "port": 80,
  "replicas": 1,
  "cpu_limit": "500m",
  "memory_limit": "256Mi",
  "domain": "test.example.com",
  "health_check_path": "/",
  "status": "deploying",
  "created_at": "2026-01-14T10:30:00Z",
  "updated_at": "2026-01-14T10:30:00Z",
  "last_deployed_at": null
}
```

### List All Apps

```bash
curl http://localhost:8080/api/apps
```

### Get Single App

```bash
curl http://localhost:8080/api/apps/{id}
```

### Update App

```bash
curl -X PATCH http://localhost:8080/api/apps/{id} \
  -H "Content-Type: application/json" \
  -d '{
    "replicas": 2,
    "memory_limit": "512Mi"
  }'
```

### Restart App

```bash
curl -X POST http://localhost:8080/api/apps/{id}/restart
```

### Delete App

```bash
curl -X DELETE http://localhost:8080/api/apps/{id}
```

## Checking Deployed Apps in Kubernetes

### View Deployments

```bash
kubectl get deployments -n superfly-apps
```

### View Pods

```bash
kubectl get pods -n superfly-apps
```

### View Services

```bash
kubectl get services -n superfly-apps
```

### View Ingresses

```bash
kubectl get ingress -n superfly-apps
```

### View App Logs

```bash
kubectl logs -n superfly-apps deployment/test-nginx -f
```

### Describe Pod (for troubleshooting)

```bash
kubectl describe pod -n superfly-apps test-nginx-xxx
```

## Database Operations

### Connect to Database

```bash
make db-shell
# or
psql postgresql://superfly:superfly_dev_password@localhost:5432/superfly
```

### View Apps in Database

```sql
SELECT id, slug, name, status, image, created_at FROM apps;
```

### Reset Database

```bash
make db-reset
```

This drops all tables and reruns migrations.

## Development Workflow

### 1. Make Changes to Code

Edit files in:
- `internal/service/` - Business logic
- `internal/handlers/` - HTTP handlers
- `internal/k8s/` - Kubernetes operations

### 2. Auto-Reload (if using `make dev`)

Air will automatically rebuild and restart the server.

### 3. Test Changes

Use `curl` or Postman to test API endpoints.

### 4. Check Kubernetes

Verify resources are created correctly:

```bash
kubectl get all -n superfly-apps
```

## Adding Database Changes

### 1. Create Migration

```bash
make migrate-create NAME=add_new_column
```

This creates a new file in `db/migrations/`.

### 2. Edit Migration

Edit the generated file:

```sql
-- +goose Up
ALTER TABLE apps ADD COLUMN new_field TEXT;

-- +goose Down
ALTER TABLE apps DROP COLUMN new_field;
```

### 3. Run Migration

```bash
make migrate
```

### 4. Update SQL Queries

Edit `db/queries/apps.sql` to add queries using the new column.

### 5. Regenerate Code

```bash
make sqlc-generate
```

## Project Structure

```
superfly/
├── cmd/
│   └── api/              # API server entrypoint
│       └── main.go
│
├── internal/
│   ├── config/           # Configuration loading
│   │   └── config.go
│   ├── db/               # Generated by sqlc (don't edit manually)
│   │   ├── db.go
│   │   ├── models.go
│   │   └── apps.sql.go
│   ├── handlers/         # HTTP handlers
│   │   ├── app_handlers.go
│   │   └── health.go
│   ├── k8s/              # Kubernetes client & resources
│   │   ├── client.go
│   │   └── resources.go
│   └── service/          # Business logic
│       └── app_service.go
│
├── db/
│   ├── migrations/       # SQL migrations (goose)
│   │   └── 00001_create_apps_table.sql
│   └── queries/          # SQL queries (sqlc)
│       └── apps.sql
│
├── .env                  # Environment variables (created by setup)
├── sqlc.yaml             # sqlc configuration
├── .air.toml             # Air configuration (live reload)
└── Makefile              # Common commands
```

## Environment Variables

Create/edit `.env` file:

```bash
DATABASE_URL=postgresql://superfly:superfly_dev_password@localhost:5432/superfly?sslmode=disable
KUBERNETES_IN_CLUSTER=false
KUBECONFIG=/home/user/.kube/config
REGISTRY_URL=registry.superfly-system.svc.cluster.local:5000
API_PORT=8080
API_HOST=0.0.0.0
ENV=development
LOG_LEVEL=debug
```

## Common Issues

### PostgreSQL Connection Refused

The port-forward service might not be running:

```bash
sudo systemctl status superfly-postgres-forward.service
sudo systemctl restart superfly-postgres-forward.service
```

Or run manually:
```bash
kubectl port-forward -n superfly-system svc/postgres 5432:5432
```

### Kubernetes Connection Error

Check if K3S is running:

```bash
sudo systemctl status k3s
kubectl cluster-info
```

### App Stuck in "deploying" Status

Check pod status:

```bash
kubectl get pods -n superfly-apps
kubectl describe pod -n superfly-apps <pod-name>
kubectl logs -n superfly-apps <pod-name>
```

Common issues:
- Image pull failures (check image name)
- Port conflicts
- Resource limits too high
- Health check failing

### Build Errors with sqlc

Make sure you've run migrations first:

```bash
make migrate
make sqlc-generate
```

## Useful Make Commands

```bash
make help              # Show all commands
make dev               # Run with live reload
make build             # Build binary
make test              # Run tests
make migrate           # Run migrations
make migrate-create    # Create new migration
make sqlc-generate     # Generate Go code from SQL
make db-shell          # Open PostgreSQL shell
make db-reset          # Reset database
make clean             # Clean build artifacts
make fmt               # Format code
make lint              # Lint code
```

## Next Features to Implement

- [ ] Feature 2: Build from GitHub + Dockerfile
- [ ] Feature 3: Environment Variables
- [ ] Feature 4: View Logs (Loki)
- [ ] Feature 5: View Metrics (Prometheus + Grafana)
- [ ] Feature 6: GitHub Webhooks
- [ ] Feature 7: Multiple Domains
- [ ] Feature 8: Web UI (Svelte)

## Testing Checklist

Before committing changes:

- [ ] Code compiles: `go build ./...`
- [ ] Tests pass: `make test`
- [ ] API endpoints work: Test with curl
- [ ] K8s resources created: Check with kubectl
- [ ] App is accessible: Check deployment status
- [ ] No linter errors: `make lint`
- [ ] Code formatted: `make fmt`
